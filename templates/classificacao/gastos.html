{# templates/classificacao/gastos.html #}
{% extends "base.html" %}
{% load static %}
{% load formatadores %}
{% load utils_extras %}

{% block content %}
<div class="container py-4">

  <!-- Filtros -->
  <form class="row g-2 align-items-end mb-3" method="get">
    <div class="col-auto">
      <label class="form-label small">Fonte</label>
      <select name="fonte" class="form-select">
        <option value="cc" {% if fonte == 'cc' %}selected{% endif %}>Conta Corrente</option>
        <option value="cartao" {% if fonte == 'cartao' %}selected{% endif %}>Cartão de Crédito</option>
      </select>
    </div>

    <div class="col-auto">
      <label class="form-label small">Período (de)</label>
      <input type="date" class="form-control" name="data_ini" value="{{ data_ini }}">
    </div>
    <div class="col-auto">
      <label class="form-label small">Período (até)</label>
      <input type="date" class="form-control" name="data_fim" value="{{ data_fim }}">
    </div>

    <div class="col-auto">
      <label class="form-label small">Categoria (macro)</label>
      <select name="categoria_id" class="form-select" id="filtro-categoria">
        <option value="">Todas</option>
        <option value="0" {% if categoria_id == '0' %}selected{% endif %}>(Sem categoria)</option>
        {% for c in categorias_macro %}
          <option value="{{ c.id }}" {% if c.id|stringformat:"s" == categoria_id %}selected{% endif %}>{{ c.nome }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-auto">
      <label class="form-label small">Subcategoria</label>
      <select name="subcategoria_id" class="form-select" id="filtro-subcategoria" disabled>
        <option value="">Todas</option>
      </select>
    </div>

    <div class="col-auto">
      <label class="form-label small">Busca</label>
      <input type="search" class="form-control" name="busca" value="{{ busca }}" placeholder="Descrição">
    </div>

    <div class="col-auto">
      <label class="form-label small d-block invisible">_</label>
      <button class="btn btn-primary">Aplicar</button>
    </div>
  </form>

  <!-- Toolbar -->
  <div class="d-flex align-items-center gap-2 mb-3">
    <div class="form-check">
      <input class="form-check-input" type="checkbox" id="chk-select-all">
      <label for="chk-select-all" class="form-check-label">Selecionar todos</label>
    </div>

    <div class="vr mx-2"></div>

    <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#modalAtribuirCategoria">
      Atribuir categoria
    </button>
    <button id="btn-remover-categoria" class="btn btn-outline-danger btn-sm">
      Remover categoria
    </button>

    <div class="ms-auto badge text-bg-secondary p-2">
      Total geral (gastos normalizados): <strong>{{ total_geral|moeda_brasileira }}</strong>
    </div>
  </div>

  <!-- Lista: todas as tabelas abertas -->
  {% for cat in categorias_group %}
    <div class="card mb-3 shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>{{ cat.nome }}</strong>
        <span class="badge text-bg-primary">Total: {{ cat.total|moeda_brasileira }}</span>
      </div>

      <div class="list-group list-group-flush">
        {% for sub in cat.subcats %}
          <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">{{ sub.nome }}</h6>
              <span class="badge text-bg-info">Subtotal: {{ sub.total|moeda_brasileira }}</span>
            </div>

            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead class="table-light">
                  <tr>
                    <th style="width:36px;"></th>
                    <th style="width:110px;">Data</th>
                    <th>Descrição</th>
                    <th style="width:150px;">Membros</th>
                    <th class="text-end" style="width:160px;">Valor</th>
                  </tr>
                </thead>
                <tbody>
                  {% for it in sub.itens %}
                    <tr>
                      <td>
                        <input type="checkbox" class="chk-item" value="{{ it.id }}">
                      </td>
                      <td>{{ it|get_attr:col_data|date:"d/m/Y" }}</td>
                      <td>{{ it|get_attr:col_desc }}</td>
                      <td>
                        <div class="btn-group" id="pills-{{ it.id }}" data-fonte="{{ fonte }}" role="group" aria-label="Membros">
                          <button type="button"
                                  class="btn btn-outline-primary btn-sm {% if it.membros.all|length == membros|length %}active{% endif %}"
                                  onclick="atribuirTodosMembros('{{ it.id }}', '{{ fonte }}')">
                            Todos
                          </button>
                          {% for membro in membros %}
                            <button type="button"
                                    class="btn btn-outline-primary btn-sm {% if membro in it.membros.all %}active{% endif %}"
                                    onclick="toggleMembro(
                                      '{{ it.id }}',
                                      '{{ membro.id }}',
                                      {% if membro in it.membros.all %}true{% else %}false{% endif %},
                                      '{{ fonte }}',
                                      [{% for m in it.membros.all %}'{{ m.id }}'{% if not forloop.last %},{% endif %}{% endfor %}]
                                    )">
                              {{ membro.nome }}
                            </button>
                          {% endfor %}
                        </div>
                        <div id="msg-{{ it.id }}" class="mt-1" style="display:none;"></div>
                      </td>
                      <td class="text-end">{{ it|get_attr:col_val|moeda_brasileira }}</td>
                    </tr>
                  {% empty %}
                    <tr><td colspan="4" class="text-center text-muted py-3">Sem lançamentos.</td></tr>
                  {% endfor %}
                </tbody>
                <tfoot>
                  <tr>
                    <th colspan="3" class="text-end">Total da subcategoria:</th>
                    <th class="text-end">{{ sub.total|moeda_brasileira }}</th>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        {% empty %}
          <div class="list-group-item text-muted">Sem subcategorias.</div>
        {% endfor %}
      </div>
    </div>
  {% empty %}
    <div class="text-muted">Nenhuma categoria encontrada no filtro atual.</div>
  {% endfor %}

</div>

<!-- MODAL: Atribuir Categoria/Subcategoria -->
<div class="modal fade" id="modalAtribuirCategoria" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-3">
      <div class="modal-header">
        <h5 class="modal-title">Atribuir categoria</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Categoria (macro)</label>
          <select id="modal-categoria" class="form-select">
            <option value="">Selecione...</option>
            {# Observação: aqui mantive sem a opção "0", pois você disse que não precisa atribuir "sem categoria" #}
            {% for c in categorias_macro %}
              <option value="{{ c.id }}">{{ c.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="form-label">Subcategoria <span class="text-muted">(opcional)</span></label>
          <select id="modal-subcategoria" class="form-select" disabled>
            <option value="">Selecione a categoria primeiro</option>
          </select>
          <div class="form-text">Se não houver subcategorias, será atribuída a categoria selecionada.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="modal-btn-aplicar" type="button" class="btn btn-success">Aplicar</button>
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function showMsg(itemId, msg, tipo='success') {
  const el = document.getElementById('msg-' + itemId);
  if (!el) return;
  el.innerHTML = `<span class="badge bg-${tipo}">${msg}</span>`;
  el.style.display = 'inline-block';
  setTimeout(() => { el.style.display = 'none'; }, 1800);
}

function atribuirMembro(itemId, membroId, fonte) {
  console.log("atribuirMembro chamado:", {itemId, membroId, fonte}); // DEBUG

  const data = new FormData();
  data.append('fonte', fonte);
  data.append('item_id', itemId);

  if (membroId === 'todos') {
    {% for membro in membros %}
      data.append('membros_ids', '{{ membro.id }}');
    {% endfor %}
  } else {
    data.append('membros_ids', membroId);
  }

  fetch("{% url 'atribuir_membro_ajax' %}", {
    method: 'POST',
    headers: {'X-CSRFToken': '{{ csrf_token }}'},
    body: data
  })
  .then(resp => {
    if (!resp.ok) {
      alert("Erro na requisição AJAX: " + resp.status);
      throw new Error("Erro AJAX: " + resp.status);
    }
    return resp.json();
  })
  .then(result => {
    console.log("Resposta AJAX:", result); // DEBUG
    if (result.ok) {
      location.reload();
    } else {
      alert(result.erro || "Erro ao atribuir membro.");
    }
  })
  .catch(e => {
    alert("Falha na comunicação AJAX: " + e);
    console.error(e);
  });
}

function atribuirTodosMembros(itemId, fonte) {
  const data = new FormData();
  data.append('fonte', fonte);
  data.append('item_id', itemId);
  {% for membro in membros %}
    data.append('membros_ids', '{{ membro.id }}');
  {% endfor %}

  fetch("{% url 'atribuir_membro_ajax' %}", {
    method: 'POST',
    headers: {'X-CSRFToken': '{{ csrf_token }}'},
    body: data
  })
  .then(resp => resp.json())
  .then(result => {
    if (result.ok) {
      atualizarPills(itemId, fonte);
      showMsg(itemId, "Salvo!", "success");
    } else {
      showMsg(itemId, result.erro || "Erro ao atribuir membros.", "danger");
    }
  });
}

function toggleMembro(itemId, membroId, ativo, fonte, membrosAtuais) {
  membrosAtuais = Array.isArray(membrosAtuais) ? membrosAtuais.map(String) : [];
  membroId = String(membroId);

  if (ativo) {
    membrosAtuais = membrosAtuais.filter(id => id !== membroId);
  } else {
    if (!membrosAtuais.includes(membroId)) {
      membrosAtuais.push(membroId);
    }
  }

  const data = new FormData();
  data.append('fonte', fonte);
  data.append('item_id', itemId);
  membrosAtuais.forEach(id => data.append('membros_ids', id));

  fetch("{% url 'atribuir_membro_ajax' %}", {
    method: 'POST',
    headers: {'X-CSRFToken': '{{ csrf_token }}'},
    body: data
  })
  .then(resp => resp.json())
  .then(result => {
    if (result.ok) {
      atualizarPills(itemId, fonte);
      showMsg(itemId, "Salvo!", "success");
    } else {
      showMsg(itemId, result.erro || "Erro ao atribuir/remover membro.", "danger");
    }
  });
}

function atualizarPills(itemId, fonte) {
  fetch("{% url 'membros_transacao_ajax' %}?fonte=" + fonte + "&item_id=" + itemId)
    .then(resp => resp.json())
    .then(data => {
      if (!data.ok) return;
      const membrosNovos = data.membros_ids.map(String);
      const grupo = document.getElementById('pills-' + itemId);
      if (!grupo) return;
      let html = '';
      html += `<button type="button" class="btn btn-outline-primary btn-sm ${membrosNovos.length === {{ membros|length }} ? 'active' : ''}" onclick="atribuirTodosMembros('${itemId}', '${grupo.dataset.fonte}')">Todos</button>`;
      {% for membro in membros %}
        html += `<button type="button" class="btn btn-outline-primary btn-sm ${membrosNovos.includes('{{ membro.id }}') ? 'active' : ''}" onclick="toggleMembro('${itemId}', '{{ membro.id }}', ${membrosNovos.includes('{{ membro.id }}')}, '${fonte}', [${membrosNovos.map(id => `'${id}'`).join(',')}])">{{ membro.nome }}</button>`;
      {% endfor %}
      grupo.innerHTML = html;
    });
}

// O restante do JS pode continuar dentro do bloco imediatamente executado
(function(){
  const fonte = "{{ fonte }}";

  // CSRF via cookie
  function getCookie(name) {
    const m = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    return m ? decodeURIComponent(m[2]) : null;
  }
  const csrftoken = getCookie('csrftoken');

  // Select all
  const chkAll = document.getElementById('chk-select-all');
  chkAll?.addEventListener('change', () => {
    document.querySelectorAll('.chk-item').forEach(ch => { ch.checked = chkAll.checked; });
  });

  function selecionados() {
    const ids = [];
    document.querySelectorAll('.chk-item:checked').forEach(ch => ids.push(ch.value));
    return ids;
  }

  async function postAtribuir(categoriaId) {
    const ids = selecionados();
    if (!ids.length) { alert('Selecione ao menos um lançamento.'); return; }

    const form = new FormData();
    form.append('fonte', fonte);
    form.append('item_ids', ids.join(','));
    form.append('categoria_id', categoriaId || '0');

    const resp = await fetch("{% url 'atribuir_categoria_ajax' %}", {
      method: 'POST',
      headers: {'X-CSRFToken': csrftoken},
      body: form
    });
    const data = await resp.json();
    if (!data.ok) {
      alert('Erro: ' + (data.erro || 'desconhecido'));
      return;
    }
    location.reload();
  }

  // Remover categoria
  document.getElementById('btn-remover-categoria')?.addEventListener('click', (e) => {
    e.preventDefault();
    postAtribuir('0');
  });

  // ----- Filtro: carregar subcategorias quando categoria (macro) muda -----
  const selCatFiltro = document.getElementById('filtro-categoria');
  const selSubFiltro = document.getElementById('filtro-subcategoria');

  async function carregarSubcats(selectDestino, macroId, opts={placeholder:'Todas', selected:null}) {
    // Reseta sempre
    selectDestino.innerHTML = `<option value="">${opts.placeholder || 'Todas'}</option>`;
    selectDestino.disabled = true;

    // Caso especial: "Sem categoria" (0) ou vazio -> desabilita e não busca
    if (!macroId || String(macroId) === '0') {
      // Se for 0, não existem subcategorias
      if (String(macroId) === '0') {
        selectDestino.innerHTML = '<option value="">(Sem subcategorias)</option>';
      }
      selectDestino.disabled = true;
      return;
    }

    try {
      const url = new URL("{% url 'carregar_subcategorias_ajax' %}", window.location.origin);
      url.searchParams.set('macro_id', macroId);
      const r = await fetch(url, {headers: {'X-Requested-With': 'XMLHttpRequest'}});
      const j = await r.json();
      if (j.ok && Array.isArray(j.itens) && j.itens.length) {
        j.itens.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.id;
          opt.textContent = s.nome;
          if (opts.selected && String(opts.selected) === String(s.id)) opt.selected = true;
          selectDestino.appendChild(opt);
        });
        selectDestino.disabled = false;
      } else {
        selectDestino.innerHTML = '<option value="">(Sem subcategorias)</option>';
        selectDestino.disabled = true;
      }
    } catch(e) {
      selectDestino.innerHTML = '<option value="">(Erro ao carregar)</option>';
      selectDestino.disabled = true;
    }
  }

  // Ao mudar a macro no filtro
  selCatFiltro?.addEventListener('change', () => {
    const val = selCatFiltro.value;
    // sempre que macro muda, limpamos o valor atual da subcategoria
    selSubFiltro.value = '';
    carregarSubcats(selSubFiltro, val, {selected: ""});
  });

  // Inicialização: se já veio uma macro selecionada pela URL, carrega as subcats
  (function initFiltro(){
    const macro = selCatFiltro ? selCatFiltro.value : "";
    // "{{ subcategoria_id }}" vem da view; se vazio, não pré-seleciona nada
    const subSel = "{{ subcategoria_id }}";
    carregarSubcats(selSubFiltro, macro, {selected: subSel || ""});
  })();

  // ---------- MODAL ----------
  const modalCategoria = document.getElementById('modal-categoria');
  const modalSubcategoria = document.getElementById('modal-subcategoria');

  modalCategoria?.addEventListener('change', async () => {
    const macroId = modalCategoria.value;
    if (!macroId) {
      modalSubcategoria.innerHTML = '<option value="">Selecione a categoria primeiro</option>';
      modalSubcategoria.disabled = true;
      return;
    }
    modalSubcategoria.disabled = false;
    await carregarSubcats(modalSubcategoria, macroId, {placeholder:'Selecione...', selected:null});
    if (modalSubcategoria.options.length <= 1) {
      modalSubcategoria.innerHTML = '<option value="">(Sem subcategorias)</option>';
      modalSubcategoria.disabled = true;
    }
  });

  document.getElementById('modal-btn-aplicar')?.addEventListener('click', () => {
    const macroId = modalCategoria.value;
    if (!macroId) { alert('Escolha a categoria.'); return; }
    const subId = modalSubcategoria.disabled ? "" : modalSubcategoria.value;
    postAtribuir(subId || macroId);
  });
})();
</script>
{% endblock %}
