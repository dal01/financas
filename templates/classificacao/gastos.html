{# templates/classificacao/gastos.html #}
{% extends "base.html" %}
{% load static %}
{% load formatadores %}

{% block title %}Classificação de Gastos{% endblock %}

{% block content %}
<div class="container py-4">

  <div class="d-flex align-items-center justify-content-between mb-3 gap-2 flex-wrap">
    <h1 class="h5 mb-0">{{ title }}</h1>

    <form method="get" class="row g-2 align-items-end">
      <div class="col-auto">
        <label class="form-label mb-1">Fonte</label>
        <select class="form-select" name="fonte">
          <option value="todas" {% if fonte == 'todas' %}selected{% endif %}>Todas</option>
          <option value="cc" {% if fonte == 'cc' %}selected{% endif %}>Conta Corrente</option>
          <option value="cartao" {% if fonte == 'cartao' %}selected{% endif %}>Cartão</option>
        </select>
      </div>

      <div class="col-auto">
        <label class="form-label mb-1">Modo</label>
        <select class="form-select" name="modo" id="sel-modo">
          <option value="ano" {% if modo == 'ano' %}selected{% endif %}>Ano</option>
          <option value="mes" {% if modo == 'mes' %}selected{% endif %}>Mês</option>
        </select>
      </div>

      <div class="col-auto">
        <label class="form-label mb-1">Ano</label>
        <select class="form-select" name="ano">
          {% for a in anos_disponiveis %}
            <option value="{{ a }}" {% if a == ano %}selected{% endif %}>{{ a }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-auto" id="box-mes">
        <label class="form-label mb-1">Mês</label>
        <select class="form-select" name="mes">
          {% for midx, mlabel in meses %}
            <option value="{{ midx }}" {% if mes == midx %}selected{% endif %}>{{ mlabel }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-auto">
        <label class="form-label mb-1">Categoria (Macro)</label>
        <select class="form-select" name="macro_id" id="filtro-macro">
          <option value="">– todas –</option>
          <option value="0" {% if macro_id_sel == 0 %}selected{% endif %}>Sem categoria</option>
          {% for m in macros %}
            <option value="{{ m.id }}" {% if macro_id_sel == m.id %}selected{% endif %}>{{ m.nome }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-auto">
        <label class="form-label mb-1">Subcategoria</label>
        <select class="form-select" name="sub_id" id="filtro-sub" {% if not macro_id_sel %}disabled{% endif %}>
          <option value="">– todas –</option>
        </select>
      </div>

      <div class="col-auto">
        <label class="form-label mb-1">Busca</label>
        <input type="search" class="form-control" name="busca" placeholder="Descrição…" value="{{ busca }}">
      </div>

      <div class="col-auto">
        <button class="btn btn-outline-secondary">Filtrar</button>
      </div>
    </form>
  </div>

  <div class="mb-2 d-flex align-items-center gap-3 flex-wrap">
    <span class="badge text-bg-primary">Período: {{ periodo_label }}</span>
    <button id="btn-atribuir" class="btn btn-primary btn-sm" disabled>Atribuir categoria</button>
    <span id="sel-count" class="text-muted small">0 selecionadas</span>
  </div>

  {# Agrupado por Macro -> Sub (accordion por sub) #}
  {% for macro in grupos %}
    <div class="card mb-3">
      <div class="card-header py-2 d-flex justify-content-between align-items-center">
        <strong>{{ macro.macro_nome }}</strong>
        <span class="fw-semibold text-end">{{ macro.total_macro|moeda_brasileira }}</span>
      </div>

      <div class="card-body p-2">
        <div class="accordion" id="acc_{{ forloop.counter0 }}">
          {% for sub in macro.subs %}
            <div class="accordion-item">
              <h2 class="accordion-header" id="hdr_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}">
                <button class="accordion-button collapsed py-2"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#col_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}"
                        aria-expanded="false"
                        aria-controls="col_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}">
                  <span class="me-2">{{ sub.sub_nome }}</span>
                  <span class="ms-auto text-end small text-muted d-inline-block" style="min-width: 160px;">
                    {{ sub.total_sub|moeda_brasileira }}
                  </span>
                </button>
              </h2>
              <div id="col_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}"
                   class="accordion-collapse collapse"
                   aria-labelledby="hdr_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}"
                   data-bs-parent="#acc_{{ forloop.parentloop.counter0 }}">
                <div class="accordion-body p-0">
                  <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0">
                      <thead>
                        <tr>
                          <th style="width:28px"></th>
                          <th style="width:120px">Data</th>
                          <th>Descrição</th>
                          <th class="text-end" style="width:160px">Valor</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for obj in sub.items %}
                          <tr>
                            <td>
                              <input type="checkbox"
                                     class="row-check"
                                     data-origin="{{ obj.src|default:fonte }}"
                                     value="{{ obj.id }}">
                            </td>
                            <td>{{ obj.data|date:"d/m/Y" }}</td>
                            <td>{{ obj.descricao }}</td>
                            <td class="text-end">
                              {% if fonte == 'cc' %}
                                {{ obj.valor|absval|moeda_brasileira }}
                              {% else %}
                                {{ obj.valor|moeda_brasileira }}
                              {% endif %}
                            </td>
                          </tr>
                        {% empty %}
                          <tr><td colspan="4" class="text-center text-muted py-3">Sem lançamentos</td></tr>
                        {% endfor %}
                      </tbody>
                      <tfoot>
                        <tr>
                          <th colspan="3" class="text-end">Total da subcategoria</th>
                          <td class="text-end fw-semibold">{{ sub.total_sub|moeda_brasileira }}</td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  {% empty %}
    <div class="text-center text-muted py-4">Nenhum lançamento no período/filtros.</div>
  {% endfor %}

</div>

{# Modal de Categoria #}
<div class="modal fade" id="modalCategoria" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h5 class="modal-title">Atribuir categoria</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">

        <div class="mb-2">
          <label class="form-label mb-1">Macro</label>
          <select id="sel-macro" class="form-select form-select-sm">
            <option value="">– selecione –</option>
            <option value="0">Sem categoria</option>
            {% for m in macros %}
              <option value="{{ m.id }}">{{ m.nome }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label class="form-label mb-1">Subcategoria</label>
          <select id="sel-sub" class="form-select form-select-sm" disabled>
            <option value="">– selecione a macro –</option>
          </select>
        </div>

      </div>
      <div class="modal-footer py-2">
        <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary btn-sm" id="btn-confirmar" disabled>Aplicar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ==== CSRF ====
function getCookie(name) {
  const cookieStr = document.cookie;
  if (!cookieStr) return null;
  const cookies = cookieStr.split(';');
  for (let c of cookies) {
    c = c.trim();
    if (c.startsWith(name + '=')) return decodeURIComponent(c.substring(name.length + 1));
  }
  return null;
}
const CSRF_TOKEN = getCookie('csrftoken');

(function(){
  const btnAtribuir = document.getElementById('btn-atribuir');
  const selCount = document.getElementById('sel-count');

  // Toggle mês
  const selModo = document.getElementById('sel-modo');
  const boxMes = document.getElementById('box-mes');
  function toggleMes(){ boxMes.style.display = selModo.value === 'mes' ? '' : 'none'; }
  toggleMes();
  selModo.addEventListener('change', toggleMes);

  const allRowChecks = () => Array.from(document.querySelectorAll('.row-check'));

  function updateSelection() {
    const selected = allRowChecks().filter(c => c.checked).length;
    selCount.textContent = `${selected} selecionadas`;
    btnAtribuir.disabled = selected === 0;
  }
  allRowChecks().forEach(c => c.addEventListener('change', updateSelection));

  // Modal
  const selMacro = document.getElementById('sel-macro');
  const selSub = document.getElementById('sel-sub');
  const btnConfirmar = document.getElementById('btn-confirmar');
  const modalEl = document.getElementById('modalCategoria');
  const modal = new bootstrap.Modal(modalEl);

  btnAtribuir.addEventListener('click', () => {
    selMacro.value = '';
    selSub.innerHTML = '<option value="">– selecione a macro –</option>';
    selSub.disabled = true;
    btnConfirmar.disabled = true;
    modal.show();
  });

  selMacro.addEventListener('change', async () => {
    const macroId = selMacro.value;
    selSub.disabled = true;
    btnConfirmar.disabled = true;

    if (macroId === '') {
      selSub.innerHTML = '<option value="">– selecione a macro –</option>';
      return;
    }
    if (macroId === '0') {
      selSub.innerHTML = '<option value="">– sem sub –</option>';
      selSub.disabled = true;
      btnConfirmar.disabled = false;
      return;
    }

    const url = "{% url 'carregar_subcategorias_ajax' %}" + `?macro_id=${macroId}`;
    const resp = await fetch(url, { credentials: 'same-origin' });
    const data = await resp.json();
    selSub.innerHTML = '<option value="">– selecione –</option>';
    for (const item of data.items) {
      const opt = document.createElement('option');
      opt.value = item.id;
      opt.textContent = item.nome;
      selSub.appendChild(opt);
    }
    selSub.disabled = false;
  });

  selSub.addEventListener('change', () => {
    btnConfirmar.disabled = !(selSub.value || selMacro.value === '0');
  });

  // Submit: separa ids por origem
  document.getElementById('btn-confirmar').addEventListener('click', async () => {
    const marcados = allRowChecks().filter(c => c.checked);
    if (!marcados.length) return;

    const idsCC = [];
    const idsCartao = [];

    for (const c of marcados) {
      const origin = (c.dataset.origin || '').toLowerCase();
      if (origin === 'cc') idsCC.push(c.value);
      else if (origin === 'cartao') idsCartao.push(c.value);
      else { alert('Não foi possível identificar a origem de um lançamento selecionado.'); return; }
    }

    const form = new FormData();
    if (idsCC.length)     form.append('ids_cc', idsCC.join(','));
    if (idsCartao.length) form.append('ids_cartao', idsCartao.join(','));

    if (selMacro.value === '0') {
      form.append('categoria_id', '');
    } else {
      form.append('categoria_id', selSub.value || selMacro.value);
    }

    const url = "{% url 'atribuir_categoria_ajax' %}";
    const resp = await fetch(url, {
      method: 'POST',
      body: form,
      headers: { 'X-CSRFToken': CSRF_TOKEN },
      credentials: 'same-origin',
    });

    if (resp.ok) {
      const p = new URLSearchParams(window.location.search);
      window.location.search = p.toString();
    } else {
      const txt = await resp.text();
      alert('Falha ao aplicar categoria.\n' + txt.slice(0, 500));
    }
  });

  // Preenche filtro de Sub ao carregar (se já houver Macro)
  (async function hydrateFiltroSub(){
    const macroId = "{{ macro_id_sel|default:'' }}";
    const subId = "{{ sub_id_sel|default:'' }}";
    const subSel = document.getElementById('filtro-sub');

    if (!macroId) return;

    if (macroId === '0') {
      subSel.innerHTML = '<option value="">– todas –</option>';
      subSel.disabled = true;
      return;
    }
    const url = "{% url 'carregar_subcategorias_ajax' %}" + `?macro_id=${macroId}`;
    const resp = await fetch(url, { credentials: 'same-origin' });
    const data = await resp.json();
    subSel.innerHTML = '<option value="">– todas –</option>';
    for (const item of data.items) {
      const opt = document.createElement('option');
      opt.value = item.id;
      opt.textContent = item.nome;
      if (subId && String(item.id) === String(subId)) opt.selected = true;
      subSel.appendChild(opt);
    }
    subSel.disabled = false;
  })();

})();
</script>
{% endblock %}
