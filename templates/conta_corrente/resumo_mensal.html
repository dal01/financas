{% extends "base.html" %}
{% load formatadores %}
{% load get_item %}

{% block content %}
<div class="container py-4">
  <!-- Cabeçalho e filtros -->
  <div class="d-flex align-items-center mb-3">
    <h1 class="h4 mb-0">Resumo Mensal</h1>
    <div class="ms-3 d-flex align-items-center gap-2 flex-wrap">
      <span class="badge text-bg-primary">Período: {{ inicio }} → {{ fim }}</span>
      {% if conta %}
        <span class="badge text-bg-info">Conta: {{ conta.instituicao.nome }} — {{ conta.numero }}</span>
      {% endif %}
    </div>
  </div>
  <form class="row g-2 mb-4">
    {% if conta %}<input type="hidden" name="conta" value="{{ conta.id }}">{% endif %}
    <div class="col-12 col-sm-auto">
      <input type="month" class="form-control" name="inicio" value="{{ inicio }}">
    </div>
    <div class="col-12 col-sm-auto">
      <input type="month" class="form-control" name="fim" value="{{ fim }}">
    </div>
    <div class="col-12 col-sm-auto">
      <button class="btn btn-primary">Atualizar</button>
      <a class="btn btn-outline-secondary" href="{% url 'conta_corrente:resumo_mensal' %}{% if conta %}?conta={{ conta.id }}{% endif %}">Limpar</a>
      <a class="btn btn-outline-dark" href="?{% if conta %}conta={{ conta.id }}&amp;{% endif %}{% if inicio %}inicio={{ inicio }}&amp;{% endif %}{% if fim %}fim={{ fim }}&amp;{% endif %}format=json">JSON</a>
    </div>
  </form>

  <!-- Cards Totais (geral do período) -->
  <div class="row g-3 mb-3">
    <div class="col-12 col-md-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="text-secondary small">Entradas (total)</div>
          <div class="fs-4 fw-semibold text-success">{{ totais.entradas|moeda_brasileira }}</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="text-secondary small">Saídas (total)</div>
          <div class="fs-4 fw-semibold text-danger">{{ totais.saidas|moeda_brasileira }}</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="text-secondary small">Saldo (total)</div>
          <div class="fs-4 fw-semibold">{{ totais.saldo|moeda_brasileira }}</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div class="text-secondary small">Poupança no período</div>
            <span class="badge {% if totais.poupado_pct|floatformat:2 < 0 %}text-bg-danger{% else %}text-bg-primary{% endif %}">
              {{ totais.poupado_pct }}%
            </span>
          </div>
          <div class="mt-2">
            <div class="progress" role="progressbar"
                 aria-valuemin="0" aria-valuemax="100"
                 aria-valuenow="{{ totais.poupado_pct_clamp|floatformat:0 }}">
              <div class="progress-bar"
                   style="width: {{ totais.poupado_pct_clamp|floatformat:0|default_if_none:'0' }}%;"></div>
            </div>
            <div class="small text-muted mt-1">
              Percentual calculado como <em>saldo ÷ entradas × 100</em>.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabela Mensal (geral) -->
  <div class="table-responsive mb-4">
    <table class="table table-sm align-middle">
      <thead>
        <tr>
          <th>Mês</th>
          <th class="text-end">Entradas</th>
          <th class="text-end">Saídas</th>
          <th class="text-end">Saldo</th>
        </tr>
      </thead>
      <tbody>
        {% for r in serie %}
          <tr>
            <td>{{ r.mes }}</td>
            <td class="text-end text-success">{{ r.entradas|moeda_brasileira }}</td>
            <td class="text-end text-danger">{{ r.saidas|moeda_brasileira }}</td>
            <td class="text-end">{{ r.saldo|moeda_brasileira }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="4" class="text-center text-muted">Sem dados no período.</td></tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr class="fw-semibold">
          <td>Total</td>
          <td class="text-end text-success">{{ totais.entradas|moeda_brasileira }}</td>
          <td class="text-end text-danger">{{ totais.saidas|moeda_brasileira }}</td>
          <td class="text-end">{{ totais.saldo|moeda_brasileira }}</td>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- ===================== Resumo por Membro ===================== -->
  <div class="mb-2">
    <h4 class="mb-3">Resumo por Membro</h4>
  </div>

  {% for membro in por_membro %}
    <!-- Nome do membro -->
    <div class="d-flex align-items-center mt-4 mb-2">
      <h5 class="mb-0">{{ membro.membro_nome }}</h5>
      <hr class="flex-grow-1 ms-3">
    </div>

    <!-- Cards do membro -->
    <div class="row g-3 mb-3">
      <div class="col-12 col-md-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="text-secondary small">Entradas</div>
            <div class="fs-5 fw-semibold text-success">{{ membro.totais.entradas|moeda_brasileira }}</div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="text-secondary small">Saídas</div>
            <div class="fs-5 fw-semibold text-danger">{{ membro.totais.saidas|moeda_brasileira }}</div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="text-secondary small">Saldo</div>
            <div class="fs-5 fw-semibold">{{ membro.totais.saldo|moeda_brasileira }}</div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div class="text-secondary small">Poupança no período</div>
              <span class="badge {% if membro.poupado_pct|floatformat:2 < 0 %}text-bg-danger{% else %}text-bg-primary{% endif %}">
                {{ membro.poupado_pct }}%
              </span>
            </div>
            <div class="mt-2">
              <div class="progress" role="progressbar"
                   aria-valuemin="0" aria-valuemax="100"
                   aria-valuenow="{{ membro.poupado_pct_clamp|floatformat:0 }}">
                <div class="progress-bar"
                     style="width: {{ membro.poupado_pct_clamp|floatformat:0|default_if_none:'0' }}%;"></div>
              </div>
              <div class="small text-muted mt-1">
                Percentual calculado como <em>saldo ÷ entradas × 100</em>.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabela do membro: Instituição / Conta / Totais -->
    <div class="table-responsive mt-2">
      <table class="table table-sm align-middle mb-0">
        <thead>
          <tr>
            <th>Instituição / Conta</th>
            <th class="text-end">Entradas</th>
            <th class="text-end">Saídas</th>
            <th class="text-end">Saldo</th>
          </tr>
        </thead>
        <tbody>
          {% for c in membro.contas %}
            <tr>
              <td>{{ c.instituicao }} — {{ c.numero }}</td>
              <td class="text-end text-success">{{ c.entradas|moeda_brasileira }}</td>
              <td class="text-end text-danger">{{ c.saidas|moeda_brasileira }}</td>
              <td class="text-end">{{ c.saldo|moeda_brasileira }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="4" class="text-center text-muted">Sem contas para este membro.</td></tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr class="fw-semibold">
            <td>Total do membro</td>
            <td class="text-end text-success">{{ membro.totais.entradas|moeda_brasileira }}</td>
            <td class="text-end text-danger">{{ membro.totais.saidas|moeda_brasileira }}</td>
            <td class="text-end">{{ membro.totais.saldo|moeda_brasileira }}</td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- Detalhamento por Conta e Mês -->
    {% for conta in membro.contas %}
      <div class="mt-3 mb-2 fw-semibold">
        {{ conta.instituicao }} — Conta {{ conta.numero }}
      </div>
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>Mês</th>
            <th class="text-end">Entradas</th>
            <th class="text-end">Saídas</th>
            <th class="text-end">Saldo</th>
          </tr>
        </thead>
        <tbody>
          {% for mes in serie %}
            {% with entrada=conta.mes_entradas|get_item:mes.mes saida=conta.mes_saidas|get_item:mes.mes %}
              {% if entrada or saida %}
                <tr>
                  <td>{{ mes.mes }}</td>
                  <td class="text-end text-success">
                    {{ entrada|moeda_brasileira|default:"0,00" }}
                  </td>
                  <td class="text-end text-danger">
                    {{ saida|moeda_brasileira|default:"0,00" }}
                  </td>
                  <td class="text-end">
                    {{ conta.mes_saldo|get_item:mes.mes|moeda_brasileira|default:"0,00" }}
                  </td>
                </tr>
              {% endif %}
            {% endwith %}
          {% endfor %}
          <tr class="table-light fw-bold">
            <td>Total</td>
            <td class="text-end text-success">{{ conta.entradas|moeda_brasileira }}</td>
            <td class="text-end text-danger">{{ conta.saidas|moeda_brasileira }}</td>
            <td class="text-end">{{ conta.saldo|moeda_brasileira }}</td>
          </tr>
        </tbody>
      </table>
    {% endfor %}

    {% if not forloop.last %}<hr class="my-4">{% endif %}
  {% empty %}
    <div class="text-muted">Sem dados por membro no período.</div>
  {% endfor %}
  <div style="height: 80px;"></div>
</div>
{% endblock %}
