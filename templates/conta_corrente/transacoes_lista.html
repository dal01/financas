{% extends "base.html" %}
{% load formatadores %}

{% block content %}
<div class="container py-4">
  <div class="d-flex align-items-center mb-3">
    <h1 class="h4 mb-0">Transações</h1>
    <div class="ms-3 d-flex align-items-center gap-2 flex-wrap">
      {% if periodo %}
        <span class="badge text-bg-primary">Período: {{ periodo }}</span>
      {% elif ano %}
        <span class="badge text-bg-primary">Ano: {{ ano }}</span>
      {% endif %}
      {% if conta %}
        <span class="badge text-bg-info">Conta: {{ conta.instituicao.nome }} - {{ conta.numero }}</span>
      {% endif %}
      {% if itens_ocultas %}
        <span class="badge text-bg-warning" title="Transações separadas por regras de ocultação">
          Ignoradas: {{ itens_ocultas|length }}
        </span>
      {% endif %}
    </div>
  </div>

  <!-- Resumo geral -->
  <div class="row g-3 mb-3">
    <div class="col-12 col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="text-secondary small">Entradas</div>
          <div class="fs-5 fw-semibold text-success">{{ entradas|default_if_none:0|moeda_brasileira }}</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="text-secondary small">Saídas</div>
          <div class="fs-5 fw-semibold text-danger">{{ saidas|default_if_none:0|moeda_brasileira }}</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="text-secondary small">Saldo no período</div>
          <div class="fs-5 fw-semibold">{{ total|default_if_none:0|moeda_brasileira }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <form class="row g-2 mb-3">
    <input type="hidden" name="conta" value="{{ conta_id|default_if_none:'' }}">

    <div class="col-12 col-sm-auto">
      <select class="form-select" name="periodo">
        <option value="">-- Mês específico --</option>
        {% for m in ultimos_meses %}
          <option value="{{ m.value }}" {% if periodo == m.value %}selected{% endif %}>{{ m.label }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-12 col-sm-2">
      <input type="number" min="2000" max="2099" step="1" class="form-control"
             name="ano" value="{{ ano|default:hoje.year }}" placeholder="Ano">
    </div>

    <div class="col-12 col-sm-4">
      <input type="text" class="form-control" name="q" placeholder="Buscar descrição..." value="{{ q }}">
    </div>

    <div class="col-12 col-sm-auto">
      <select class="form-select" name="ord">
        <option value="mais_novo"  {% if ord == 'mais_novo' %}selected{% endif %}>Mais novo primeiro</option>
        <option value="mais_velho" {% if ord == 'mais_velho' %}selected{% endif %}>Mais velho primeiro</option>
        <option value="maior_valor" {% if ord == 'maior_valor' %}selected{% endif %}>Maior valor</option>
        <option value="menor_valor" {% if ord == 'menor_valor' %}selected{% endif %}>Menor valor</option>
      </select>
    </div>

    <div class="col-12 col-sm-auto">
      <button class="btn btn-primary">Filtrar</button>
      {% if conta %}
        <a class="btn btn-outline-secondary" href="{% url 'conta_corrente:transacoes_lista' %}?conta={{ conta.id }}">Limpar período</a>
      {% else %}
        <a class="btn btn-outline-secondary" href="{% url 'conta_corrente:transacoes_lista' %}">Limpar filtros</a>
      {% endif %}
    </div>
  </form>

  {# ============ AGRUPAMENTO VISÍVEIS: Membro → Instituição → Conta ============ #}
  {% if itens %}
    {% regroup itens by membro_nome as grupos_membro %}
    {% for gm in grupos_membro %}
      <div class="d-flex align-items-center mt-4 mb-2">
        <h4 class="mb-0">{{ gm.grouper }}</h4>
        <hr class="flex-grow-1 ms-3">
      </div>

      {# --- Cards resumo por membro (dados já vêm prontos da view em gm.list.0.m_totais) --- #}
      {% with tm=gm.list.0.m_totais %}
      <div class="row g-3 mb-3">
        <div class="col-12 col-md-4">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="text-secondary small">Entradas</div>
              <div class="fs-5 fw-semibold text-success">{{ tm.entradas|moeda_brasileira }}</div>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="text-secondary small">Saídas</div>
              <div class="fs-5 fw-semibold text-danger">{{ tm.saidas|moeda_brasileira }}</div>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="text-secondary small">Saldo</div>
              <div class="fs-5 fw-semibold">{{ tm.total|moeda_brasileira }}</div>
            </div>
          </div>
        </div>
      </div>
      {% endwith %}

      {% regroup gm.list by inst_nome_norm as grupos_inst %}
      {% for gi in grupos_inst %}
        <div class="d-flex align-items-center mt-2 mb-2">
          <h5 class="mb-0">{{ gi.list.0.inst_titulo }}</h5>
          <hr class="flex-grow-1 ms-3">
        </div>

        {% regroup gi.list by conta_numero as grupos_conta %}
        {% for gc in grupos_conta %}
          <div class="d-flex align-items-center mt-2 mb-1">
            <div class="badge text-bg-info">Conta {{ gc.grouper }}</div>
            <span class="text-muted small ms-2">({{ gc.list|length }} itens)</span>
          </div>

          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Descrição</th>
                  <th class="text-end">Valor</th>
                  <th>Membros</th>
                  <th style="width:1%">Ações</th>
                </tr>
              </thead>
              <tbody>
                {% for item in gc.list %}
                  {% with t=item.t %}
                  <tr>
                    <td>{{ t.data|date:"Y-m-d" }}</td>
                    <td>{{ t.descricao }}</td>
                    <td class="text-end {% if t.valor > 0 %}text-success{% elif t.valor < 0 %}text-danger{% endif %}">
                      {{ t.valor|moeda_brasileira }}
                    </td>

                    <!-- Coluna de Membros: botão "Todos" + tags -->
                    <td class="text-wrap">
                      <div class="d-flex flex-wrap gap-2">
                        <!-- Botão TODOS -->
                        <form method="post" action="{% url 'conta_corrente:transacao_toggle_membro' %}" class="d-inline">
                          {% csrf_token %}
                          <input type="hidden" name="transacao_id" value="{{ t.id }}">
                          <input type="hidden" name="membro_id" value="todos">
                          <input type="hidden" name="return_url" value="{{ request.get_full_path }}">
                          {% if t.membros.all|length == membros|length and membros|length > 0 %}
                            <button class="btn btn-sm rounded-pill px-2 py-0 btn-primary" title="Remover todos">Todos</button>
                          {% else %}
                            <button class="btn btn-sm rounded-pill px-2 py-0 btn-outline-primary" title="Atribuir todos">Todos</button>
                          {% endif %}
                        </form>

                        <!-- Tags por membro -->
                        {% for m in membros %}
                          <form method="post" action="{% url 'conta_corrente:transacao_toggle_membro' %}" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="transacao_id" value="{{ t.id }}">
                            <input type="hidden" name="membro_id" value="{{ m.id }}">
                            <input type="hidden" name="return_url" value="{{ request.get_full_path }}">
                            <button type="submit"
                              class="btn btn-sm rounded-pill px-2 py-0 {% if m in t.membros.all %}btn-primary{% else %}btn-outline-primary{% endif %}"
                              title="{% if m in t.membros.all %}Remover{% else %}Adicionar{% endif %} {{ m.nome }}">
                              {{ m.nome }}
                            </button>
                          </form>
                        {% empty %}
                          <span class="text-muted small">Sem membros cadastrados</span>
                        {% endfor %}
                      </div>
                    </td>

                    <!-- Ações -->
                    <td class="text-nowrap">
                      <form method="post" action="{% url 'conta_corrente:transacao_toggle_oculta' t.id %}" class="d-inline">
                        {% csrf_token %}
                        <input type="hidden" name="return_url" value="{{ request.get_full_path }}">
                        <button class="btn btn-sm btn-outline-secondary" title="Ocultar este lançamento">
                          Ocultar
                        </button>
                      </form>
                    </td>
                  </tr>
                  {% endwith %}
                {% empty %}
                  <tr><td colspan="5" class="text-center text-muted">Nenhum lançamento nesta conta.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endfor %}
      {% endfor %}
    {% endfor %}
  {% else %}
    <div class="text-muted">Sem transações para exibir.</div>
  {% endif %}

  <!-- Paginação -->
  {% if page_obj.paginator.num_pages > 1 %}
    <nav aria-label="Paginação">
      <ul class="pagination">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?{% if conta_id %}conta={{ conta_id }}&{% endif %}{% if periodo %}periodo={{ periodo }}&{% endif %}{% if ano %}ano={{ ano }}&{% endif %}{% if q %}q={{ q|urlencode }}&{% endif %}ord={{ ord }}&pagina={{ page_obj.previous_page_number }}">Anterior</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Anterior</span></li>
        {% endif %}

        <li class="page-item disabled">
          <span class="page-link">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
        </li>

        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?{% if conta_id %}conta={{ conta_id }}&{% endif %}{% if periodo %}periodo={{ periodo }}&{% endif %}{% if ano %}ano={{ ano }}&{% endif %}{% if q %}q={{ q|urlencode }}&{% endif %}ord={{ ord }}&pagina={{ page_obj.next_page_number }}">Próxima</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Próxima</span></li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}

  {# ============ AGRUPAMENTO OCULTAS (igual às visíveis): Membro → Instituição → Conta ============ #}
  {% if itens_ocultas %}
    <hr class="my-4">
    <h5 class="mb-3">Ignoradas pelas regras</h5>

    {% regroup itens_ocultas by membro_nome as grupos_membro_o %}
    {% for gm in grupos_membro_o %}
      <div class="d-flex align-items-center mt-2 mb-2">
        <h5 class="mb-0">{{ gm.grouper }}</h5>
        <hr class="flex-grow-1 ms-3">
      </div>

      {% regroup gm.list by inst_nome_norm as grupos_inst_o %}
      {% for gi in grupos_inst_o %}
        <div class="d-flex align-items-center mt-2 mb-2">
          <h6 class="mb-0">{{ gi.list.0.inst_titulo }}</h6>
          <hr class="flex-grow-1 ms-3">
        </div>

        {% regroup gi.list by conta_numero as grupos_conta_o %}
        {% for gc in grupos_conta_o %}
          <div class="d-flex align-items-center mt-2 mb-1">
            <div class="badge text-bg-info">Conta {{ gc.grouper }}</div>
            <span class="text-muted small ms-2">({{ gc.list|length }} itens)</span>
          </div>

          <div class="table-responsive">
            <table class="table table-sm align-middle table-bordered">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Descrição</th>
                  <th class="text-end">Valor</th>
                  <th>Membros</th>
                  <th style="width:1%">Ações</th>
                </tr>
              </thead>
              <tbody>
                {% for item in gc.list %}
                  {% with t=item.t %}
                  <tr class="text-muted">
                    <td>{{ t.data|date:"Y-m-d" }}</td>
                    <td>{{ t.descricao }}</td>
                    <td class="text-end {% if t.valor > 0 %}text-success{% elif t.valor < 0 %}text-danger{% endif %}">
                      {{ t.valor|moeda_brasileira }}
                    </td>
                    <td>
                      <div class="d-flex flex-wrap gap-2">
                        {% if t.membros.all|length == membros|length and membros|length > 0 %}
                          <span class="badge rounded-pill text-bg-primary">Todos</span>
                        {% else %}
                          <span class="badge rounded-pill text-bg-light border border-primary text-primary">Todos</span>
                        {% endif %}
                        {% for m in membros %}
                          {% if m in t.membros.all %}
                            <span class="badge rounded-pill text-bg-primary">{{ m.nome }}</span>
                          {% else %}
                            <span class="badge rounded-pill text-bg-light border border-primary text-primary">{{ m.nome }}</span>
                          {% endif %}
                        {% empty %}
                          <span class="text-muted small">Sem membros cadastrados</span>
                        {% endfor %}
                      </div>
                    </td>
                    <td class="text-nowrap">
                      {% if t.oculta_manual %}
                        <form method="post" action="{% url 'conta_corrente:transacao_toggle_oculta' t.id %}">
                          {% csrf_token %}
                          <input type="hidden" name="return_url" value="{{ request.get_full_path }}">
                          <button class="btn btn-sm btn-outline-primary" title="Reexibir este lançamento">
                            Reexibir
                          </button>
                        </form>
                      {% else %}
                        <span class="text-muted small" title="Ocultada por regra">por regra</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endwith %}
                {% empty %}
                  <tr><td colspan="5" class="text-center text-muted">Nenhum lançamento nesta conta.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endfor %}
      {% endfor %}
    {% endfor %}
  {% endif %}

</div>
{% endblock %}
