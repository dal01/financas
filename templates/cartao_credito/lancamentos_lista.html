{% load static %}
<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Lançamentos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 (ajuste se já tiver no base.html) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h4 mb-0">Lançamentos</h1>
    <span class="badge text-bg-primary">Total: R$ {{ soma_valor|floatformat:2 }}</span>
  </div>
<!-- Cards de totais -->
<div class="row g-3 mb-3">
  <div class="col-12 col-lg-4">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="card-title mb-0">Por Membro</h5>
          <span class="badge text-bg-primary">Total: R$ {{ soma_valor|floatformat:2 }}</span>
        </div>
        <ul class="list-group list-group-flush">
          {% for r in aggs.por_membro|slice:":6" %}
            <li class="list-group-item d-flex justify-content-between">
              <span>{{ r.fatura__cartao__membro__nome|default:"—" }}</span>
              <strong>R$ {{ r.soma|floatformat:2 }}</strong>
            </li>
          {% empty %}
            <li class="list-group-item text-muted">Sem dados</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-4">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title mb-2">Por Instituição</h5>
        <ul class="list-group list-group-flush">
          {% for r in aggs.por_instituicao|slice:":6" %}
            <li class="list-group-item d-flex justify-content-between">
              <span>{{ r.fatura__cartao__instituicao__nome|default:"—" }}</span>
              <strong>R$ {{ r.soma|floatformat:2 }}</strong>
            </li>
          {% empty %}
            <li class="list-group-item text-muted">Sem dados</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-4">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title mb-2">Por Cartão</h5>
        <ul class="list-group list-group-flush">
          {% for r in aggs.por_cartao|slice:":6" %}
            <li class="list-group-item d-flex justify-content-between">
              <span>
                {{ r.fatura__cartao__instituicao__nome|default:"—" }} • ****{{ r.fatura__cartao__cartao_final|default:"—" }}
                {% if r.fatura__cartao__bandeira %} • {{ r.fatura__cartao__bandeira }}{% endif %}
              </span>
              <strong>R$ {{ r.soma|floatformat:2 }}</strong>
            </li>
          {% empty %}
            <li class="list-group-item text-muted">Sem dados</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>

  <!-- Filtros -->
  <form class="card card-body mb-3">
    <div class="row g-2">
      <div class="col-12 col-md-3">
        <label class="form-label">Cartão</label>
        <select class="form-select" name="cartao">
          <option value="">— todos —</option>
          {% for c in cartoes %}
            <option value="{{ c.id }}" {% if filtros.cartao|default:'' == c.id|stringformat:"s" %}selected{% endif %}>
              {{ c.instituicao.nome }} • ****{{ c.cartao_final }} {% if c.bandeira %}• {{ c.bandeira }}{% endif %}
              {% if c.membro %}• {{ c.membro.nome }}{% endif %}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-6 col-md-2">
        <label class="form-label">Instituição</label>
        <select class="form-select" name="instituicao">
          <option value="">— todas —</option>
          {% for inst in instituicoes %}
            <option value="{{ inst.id }}" {% if filtros.instituicao|default:'' == inst.id|stringformat:"s" %}selected{% endif %}>
              {{ inst.nome }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-6 col-md-2">
        <label class="form-label">Membro</label>
        <select class="form-select" name="membro">
          <option value="">— todos —</option>
          {% for m in membros %}
            <option value="{{ m.id }}" {% if filtros.membro|default:'' == m.id|stringformat:"s" %}selected{% endif %}>
              {{ m.nome }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-6 col-md-2">
        <label class="form-label">Seção</label>
        <input type="text" class="form-control" name="secao" value="{{ filtros.secao|default:'' }}" placeholder="Ex.: ENCARGOS">
      </div>

      <div class="col-6 col-md-2">
        <label class="form-label">Mês (YYYY-MM)</label>
        <input type="month" class="form-control" name="ym" value="{{ filtros.ym|default:'' }}">
      </div>

      <div class="col-6 col-md-2">
        <label class="form-label">De (YYYY-MM)</label>
        <input type="month" class="form-control" name="ym_from" value="{{ filtros.ym_from|default:'' }}">
      </div>

      <div class="col-6 col-md-2">
        <label class="form-label">Até (YYYY-MM)</label>
        <input type="month" class="form-control" name="ym_to" value="{{ filtros.ym_to|default:'' }}">
      </div>

      <div class="col-12 col-md-4">
        <label class="form-label">Busca</label>
        <input type="text" class="form-control" name="q" value="{{ filtros.q|default:'' }}" placeholder="Descrição, cidade ou país">
      </div>

      <div class="col-12 col-md-2 d-flex align-items-end">
        <button class="btn btn-primary w-100" type="submit">Filtrar</button>
      </div>
    </div>
  </form>

  <!-- Tabela -->
  <div class="table-responsive">
    <table class="table table-sm table-striped align-middle">
      <thead class="table-light">
        <tr>
          <th style="width: 100px;">Data</th>
          <th>Descrição</th>
          <th style="width: 110px;">Seção</th>
          <th style="width: 140px;" class="text-end">Valor (R$)</th>
          <th style="width: 260px;">Cartão</th>
          <th style="width: 110px;">Competência</th>
          <th style="width: 140px;">Local</th>
          <th style="width: 160px;">Membros</th>
        </tr>
      </thead>
      <tbody>
        {% for l in page_obj.object_list %}
          <tr>
            <td>{{ l.data|date:"d/m/Y" }}</td>
            <td>
              {{ l.descricao }}
              {% if l.parcela_num and l.parcela_total %}
                <span class="badge text-bg-secondary ms-1">{{ l.etiqueta_parcela }}</span>
              {% endif %}
            </td>
            <td>{{ l.secao|default:"—" }}</td>
            <td class="text-end">{{ l.valor|floatformat:2 }}</td>
            <td>
              {% with c=l.fatura.cartao %}
                {% if c %}
                  {{ c.instituicao.nome }} • ****{{ c.cartao_final }}{% if c.bandeira %} • {{ c.bandeira }}{% endif %}
                  {% if c.membro %}<br><small class="text-muted">{{ c.membro.nome }}</small>{% endif %}
                {% else %}—{% endif %}
              {% endwith %}
            </td>
            <td>{{ l.fatura.competencia|date:"Y-m" }}</td>
            <td>
              {% if l.cidade %}{{ l.cidade }}{% endif %}
              {% if l.pais %}{% if l.cidade %} • {% endif %}{{ l.pais }}{% endif %}
              {% if not l.cidade and not l.pais %}—{% endif %}
            </td>
            <td>
              <form class="d-flex align-items-center gap-2" onsubmit="return false;">
                <select multiple class="form-select form-select-sm membros-select" data-lancamento="{{ l.id }}">
                  {% for membro in membros %}
                    <option value="{{ membro.id }}" {% if membro in l.membros.all %}selected{% endif %}>{{ membro.nome }}</option>
                  {% endfor %}
                </select>
                <button type="button" class="btn btn-sm btn-primary btn-salvar-membros" data-lancamento="{{ l.id }}">Salvar</button>
              </form>
              <div class="mt-1">
                {% for m in l.membros.all %}
                  <span class="badge text-bg-light border">{{ m.nome }}</span>
                {% empty %}
                  —
                {% endfor %}
              </div>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="8" class="text-center text-muted py-4">Sem lançamentos para os filtros aplicados.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Paginação -->
  <nav aria-label="Paginação" class="mt-3">
    <ul class="pagination pagination-sm">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link"
            href="?page={{ page_obj.previous_page_number }}{% if request.GET %}&{{ request.GET.urlencode }}{% endif %}">«</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">«</span></li>
      {% endif %}

      <li class="page-item disabled">
        <span class="page-link">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
      </li>

      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link"
            href="?page={{ page_obj.next_page_number }}{% if request.GET %}&{{ request.GET.urlencode }}{% endif %}">»</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">»</span></li>
      {% endif %}
    </ul>
  </nav>

</div>

<script>
document.querySelectorAll('.btn-salvar-membros').forEach(function(btn) {
    btn.addEventListener('click', function() {
        var lancamentoId = btn.getAttribute('data-lancamento');
        var select = document.querySelector('.membros-select[data-lancamento="' + lancamentoId + '"]');
        var membros = Array.from(select.selectedOptions).map(function(opt) { return opt.value; });

        fetch("{% url 'atualizar_membros_lancamento' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: "lancamento_id=" + lancamentoId + "&" + membros.map(m => "membros[]=" + m).join("&")
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("Membros atualizados!");
            } else {
                alert("Erro: " + data.error);
            }
        });
    });
});
</script>

</body>
</html>
