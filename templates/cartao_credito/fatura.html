{% extends "base.html" %}
{% load formatadores %}

{% block title %}Fatura {{ fatura.competencia|date:"m/Y" }} · Sistema de Finanças{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h1 class="h4 mb-1">
      Fatura {{ fatura.competencia|date:"m/Y" }}
    </h1>
    <div class="text-secondary small">
      {% if fatura.emissor %}{{ fatura.emissor }}{% endif %}
      {% if fatura.titular %} · {{ fatura.titular }}{% endif %}
      {% if fatura.cartao_final %} · **** {{ fatura.cartao_final }}{% endif %}
      {% if fatura.vencimento_em %} · Venc.: {{ fatura.vencimento_em|date:"d/m/Y" }}{% endif %}
      <span class="ms-2">ID: #{{ fatura.id }}</span>
    </div>
  </div>
  <a href="{% url 'cartao_credito:faturas_mes' %}?ano={{ fatura.competencia|date:'Y' }}&mes={{ fatura.competencia|date:'m' }}"
     class="btn btn-outline-secondary btn-sm">Voltar</a>
</div>

<!-- Resumo -->
<div class="row g-3 mb-4">
  <div class="col-12 col-md-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="text-secondary small">Débitos</div>
        <div class="fs-5 fw-semibold text-danger">
          {{ totais.total_debitos|default_if_none:0|moeda_brasileira }}
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="text-secondary small">Créditos/Ajustes</div>
        <div class="fs-5 fw-semibold text-success">
          {{ totais.total_creditos|default_if_none:0|moeda_brasileira }}
        </div>
      </div>
    </div>
  </div>

  <!-- Total calculado pelos lançamentos -->
  <div class="col-12 col-md-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="text-secondary small">Total (Lançamentos)</div>
        <div class="fs-5 fw-semibold">
          {{ tot_lanc|default_if_none:0|moeda_brasileira }}
        </div>
      </div>
    </div>
  </div>

  <!-- Total do PDF -->
  <div class="col-12 col-md-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <div class="text-secondary small">Total do PDF</div>
          {% if dif_lanc_pdf %}
            <span class="badge text-bg-warning">≠ Lanç.</span>
          {% endif %}
        </div>
        <div class="fs-5 fw-semibold">
          {{ tot_pdf|default_if_none:0|moeda_brasileira }}
        </div>

        {% if dif_lanc_pdf %}
          <div class="small mt-2">
            Diferença (Lanç. − PDF):
            <span class="fw-semibold">{{ dif_lanc_pdf|moeda_brasileira }}</span>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Tabela de lançamentos -->
<div class="table-responsive">
  <table class="table table-sm align-middle table-striped">
    <thead class="table-light">
      <tr>
        <th style="width: 110px;">Data</th>
        <th>Descrição</th>
        <th style="width: 160px;" class="text-end">Valor</th>
      </tr>
    </thead>
    <tbody>
      {% for l in lancamentos %}
        <tr>
          <td>{{ l.data|date:"d/m/Y" }}</td>
          <td>
            <div class="fw-semibold">{{ l.descricao }}</div>
            {% if l.membro %}
              <div class="small text-secondary">Membro: {{ l.membro.nome }}</div>
            {% endif %}
            {% if l.categoria %}
              <div class="small text-secondary">Categoria: {{ l.categoria.nome }}</div>
            {% endif %}
          </td>
          <td class="text-end {% if l.valor < 0 %}text-success{% else %}text-danger{% endif %}">
            {{ l.valor|moeda_brasileira }}
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="3" class="text-center text-muted py-4">Nenhum lançamento nesta fatura.</td>
        </tr>
      {% endfor %}
    </tbody>
    <tfoot>
      <tr>
        <th colspan="2">Total (Lanç.)</th>
        <th class="text-end">{{ tot_lanc|moeda_brasileira }}</th>
      </tr>
      <tr>
        <th colspan="2">Total do PDF</th>
        <th class="text-end">{{ tot_pdf|moeda_brasileira }}</th>
      </tr>
      {% if dif_lanc_pdf %}
      <tr>
        <th colspan="2">Diferença (Lanç. − PDF)</th>
        <th class="text-end">{{ dif_lanc_pdf|moeda_brasileira }}</th>
      </tr>
      {% endif %}
    </tfoot>
  </table>
</div>
{% endblock %}
